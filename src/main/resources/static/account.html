<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>账户信息</title>
  <link rel="stylesheet" href="styles.css" />
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const username = localStorage.getItem("username");
      if (!username) {
        window.location.href = "index.html";
      }
    });
  </script>
</head>
<body class="light" id="top">
  <main class="section">
    <h1 class="section__title">账户信息</h1>

    <section class="project" style="max-width: 500px; margin: auto;">
      <div id="userInfo">
        <p><strong>用户名:</strong> <span id="displayUsername"></span></p>
        <p><strong>邮箱:</strong> <span id="displayEmail"></span></p>
		<p><strong>角色:</strong> <span id="displayRole"></span></p>
      </div>
    </section>

	<section class="project" style="max-width: 500px; margin: 2rem auto; text-align: center;">
	  <h2>修改密码</h2>
	  <form id="pwChangeForm" style="display: flex; flex-direction: column; gap: 1em; align-items: center;">
	    <div style="width: 100%;">
	      <label for="oldPassword" style="display: block; text-align: left;">当前密码：</label>
	      <input type="password" id="oldPassword" required class="btn btn--plain" style="width: 100%;" />
	    </div>

	    <div style="width: 100%;">
	      <label for="newPassword" style="display: block; text-align: left;">新密码：</label>
	      <input type="password" id="newPassword" required class="btn btn--plain" style="width: 100%;" />
	    </div>

	    <div style="width: 100%;">
	      <label for="confirmPassword" style="display: block; text-align: left;">确认新密码：</label>
	      <input type="password" id="confirmPassword" required class="btn btn--plain" style="width: 100%;" />
	    </div>

	    <button type="submit" class="btn btn--outline" style="margin-top: 1em;">修改密码</button>
	    <p id="accountMsg" style="margin-top: 0.5em; color: red;"></p>
	  </form>
	</section>

    <div style="text-align: center; margin-top: 2rem;">
      <button id="logoutBtn" class="btn btn--outline" style="margin-top: 1em;">退出登录</button>
    </div>
  </main>

  <script>
    const API_BASE = "/api/user";

    document.addEventListener("DOMContentLoaded", async () => {
      const username = localStorage.getItem("username");
      const res = await fetch(`${API_BASE}/get/${username}`);
      if (res.ok) {
        const user = await res.json();
        document.getElementById("displayUsername").innerText = user.username;
        document.getElementById("displayEmail").innerText = user.email;
		document.getElementById("displayRole").innerText = user.role === "ADMIN" ? "管理员" : "普通用户";
      } else {
        document.getElementById("userInfo").innerHTML = "<p>用户信息加载失败</p>";
      }
    });

    document.getElementById("pwChangeForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const username = localStorage.getItem("username");
      const oldPassword = document.getElementById("oldPassword").value.trim();
      const newPassword = document.getElementById("newPassword").value.trim();

      const res = await fetch(`${API_BASE}/change-password`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ username, oldPassword, newPassword }),
      });

      const msg = await res.text();
      document.getElementById("accountMsg").innerText = msg;

      if (res.ok) {
        alert("密码修改成功，请重新登录！");
        localStorage.clear();
        window.location.href = "main.html";
      }
    });

    document.getElementById("logoutBtn").addEventListener("click", () => {
      localStorage.clear();
      window.location.href = "main.html";
    });
  </script>
</body>
</html>
